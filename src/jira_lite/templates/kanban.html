{% extends "base.html" %}

{% block title %}{{ project.project_slug }} - Kanban Board{% endblock %}

{% block main_class %}max-w-full overflow-x-auto{% endblock %}

{% block content %}
<!-- Macro for rendering issue cards - must be defined before use -->
{% macro render_issue_card(issue) %}
<div class="kanban-card bg-white dark:bg-dark-surface p-3 rounded-lg border border-gray-200 dark:border-dark-border hover:border-primary/50 hover:shadow-lg transition-all cursor-move"
     data-issue-key="{{ issue.key }}"
     data-priority="{{ issue.priority }}"
     data-module="{{ issue.module or '' }}"
     data-owner="{{ issue.owner or '' }}"
     data-type="{{ issue.type }}"
     data-title="{{ issue.title|lower }}"
     data-status="{{ issue.status }}"
     data-created="{{ issue.created_utc }}"
     data-updated="{{ issue.updated_utc }}">

    <!-- Card Header -->
    <div class="flex justify-between items-start mb-2">
        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">{{ issue.key }}</span>
        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
            {% if issue.priority == 'P1' %}bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 border border-red-300 dark:border-red-800{% endif %}
            {% if issue.priority == 'P2' %}bg-orange-100 dark:bg-orange-900/50 text-orange-700 dark:text-orange-300 border border-orange-300 dark:border-orange-800{% endif %}
            {% if issue.priority == 'P3' %}bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-800{% endif %}
            {% if issue.priority == 'P4' %}bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 border border-blue-300 dark:border-blue-800{% endif %}
            {% if issue.priority == 'P5' %}bg-gray-100 dark:bg-gray-800/50 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-700{% endif %}">
            {{ issue.priority }}
        </span>
    </div>

    <!-- Title -->
    <a href="/{{ project.project_id }}/issues/{{ issue.key }}"
       class="block text-sm font-medium text-gray-700 dark:text-gray-200 hover:text-primary mb-2 line-clamp-2 transition-colors">
        {{ issue.title }}
    </a>

    <!-- Metadata -->
    <div class="flex flex-wrap gap-1 text-xs">
        <span class="inline-flex items-center px-1.5 py-0.5 rounded bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300">
            {{ issue.type }}
        </span>
        {% if issue.module %}
        <span class="inline-flex items-center px-1.5 py-0.5 rounded bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">
            {{ issue.module }}
        </span>
        {% endif %}
        {% if issue.owner %}
        <span class="inline-flex items-center px-1.5 py-0.5 rounded bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300">
            {{ issue.owner|replace('agent:', '') }}
        </span>
        {% endif %}
    </div>

    {% if issue.estimated_effort %}
    <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
        ‚è± {{ issue.estimated_effort }}
    </div>
    {% endif %}

    <!-- Delete button -->
    <button onclick="deleteIssue('{{ issue.key }}', event)"
            class="mt-2 delete-btn text-xs text-red-400 hover:text-red-300 transition-colors opacity-0 hover:opacity-100"
            style="transition: opacity 0.2s;">
        üóëÔ∏è Delete
    </button>
</div>
{% endmacro %}

<div class="h-full flex flex-col">
    <!-- Header with Filters -->
    <div class="bg-white dark:bg-dark-surface border-b border-gray-200 dark:border-dark-border sticky top-0 z-10 flex-shrink-0">
        <div class="px-4 py-3">
            <!-- Project Info and Actions -->
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">{{ project.project_slug }}</h1>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Kanban Board</p>
                </div>
                <div class="flex space-x-2">
                    <a href="/{{ project.project_id }}/issues/new" class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded bg-primary hover:bg-blue-600 text-white transition-colors">
                        ‚ûï Create Issue
                    </a>
                    <a href="/{{ project.project_id }}/archive" class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded bg-teal-600 hover:bg-teal-700 text-white transition-colors">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                        </svg>
                        Archive
                    </a>
                    <a href="/{{ project.project_id }}" class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-dark-border text-sm font-medium rounded text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-dark-surface hover:bg-gray-200 dark:hover:bg-dark-hover transition-colors">
                        üìä Dashboard
                    </a>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="border-t border-gray-200 dark:border-dark-border pt-3">
                <div class="flex flex-wrap gap-2 items-center">
                    <!-- Quick Search -->
                    <div class="flex-1 max-w-xs">
                        <input type="text" id="quick-search" placeholder="Quick search..."
                               class="w-full px-3 py-1.5 text-sm bg-white dark:bg-dark-bg border border-gray-300 dark:border-dark-border rounded focus:outline-none focus:ring-2 focus:ring-primary text-gray-900 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500">
                    </div>

                    <!-- Date Range Filters -->
                    <div class="flex items-center space-x-2">
                        <label class="text-xs text-gray-600 dark:text-gray-400">Created:</label>
                        <input type="date" id="created-from"
                               class="px-2 py-1 text-sm bg-white dark:bg-dark-bg border border-gray-300 dark:border-dark-border rounded focus:outline-none focus:ring-2 focus:ring-primary text-gray-900 dark:text-gray-200">
                        <span class="text-gray-600 dark:text-gray-400">-</span>
                        <input type="date" id="created-to"
                               class="px-2 py-1 text-sm bg-white dark:bg-dark-bg border border-gray-300 dark:border-dark-border rounded focus:outline-none focus:ring-2 focus:ring-primary text-gray-900 dark:text-gray-200">
                    </div>

                    <!-- Priority Filter -->
                    <select id="priority-filter" class="px-3 py-1.5 text-sm bg-white dark:bg-dark-bg border border-gray-300 dark:border-dark-border rounded focus:outline-none focus:ring-2 focus:ring-primary text-gray-900 dark:text-gray-200">
                        <option value="">All Priorities</option>
                        <option value="P1">P1 - Critical</option>
                        <option value="P2">P2 - High</option>
                        <option value="P3">P3 - Medium</option>
                        <option value="P4">P4 - Low</option>
                        <option value="P5">P5 - Nice-to-have</option>
                    </select>

                    <!-- Module Filter -->
                    <select id="module-filter" class="px-3 py-1.5 text-sm bg-white dark:bg-dark-bg border border-gray-300 dark:border-dark-border rounded focus:outline-none focus:ring-2 focus:ring-primary text-gray-900 dark:text-gray-200">
                        <option value="">All Modules</option>
                        {% set modules = [] %}
                        {% for issue in issues %}
                            {% if issue.module and issue.module not in modules %}
                                {% set _ = modules.append(issue.module) %}
                            {% endif %}
                        {% endfor %}
                        {% for module in modules|sort %}
                            <option value="{{ module }}">{{ module }}</option>
                        {% endfor %}
                    </select>

                    <!-- Owner Filter -->
                    <select id="owner-filter" class="px-3 py-1.5 text-sm bg-white dark:bg-dark-bg border border-gray-300 dark:border-dark-border rounded focus:outline-none focus:ring-2 focus:ring-primary text-gray-900 dark:text-gray-200">
                        <option value="">All Owners</option>
                        {% set owners = [] %}
                        {% for issue in issues %}
                            {% if issue.owner and issue.owner not in owners %}
                                {% set _ = owners.append(issue.owner) %}
                            {% endif %}
                        {% endfor %}
                        {% for owner in owners|sort %}
                            <option value="{{ owner }}">{{ owner }}</option>
                        {% endfor %}
                    </select>

                    <!-- Type Filter -->
                    <select id="type-filter" class="px-3 py-1.5 text-sm bg-white dark:bg-dark-bg border border-gray-300 dark:border-dark-border rounded focus:outline-none focus:ring-2 focus:ring-primary text-gray-900 dark:text-gray-200">
                        <option value="">All Types</option>
                        <option value="feature">Feature</option>
                        <option value="bug">Bug</option>
                        <option value="refactor">Refactor</option>
                        <option value="chore">Chore</option>
                        <option value="spike">Spike</option>
                    </select>

                    <!-- Toggle Completed -->
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="show-completed" class="mr-2 accent-primary" checked>
                        <span class="text-sm text-gray-700 dark:text-gray-300">Show Completed</span>
                    </label>

                    {% if project.submodules %}
                    <!-- Swimlane Toggle for Submodules -->
                    <button id="toggle-swimlanes" class="px-3 py-1.5 text-sm text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-dark-border rounded hover:bg-gray-100 dark:hover:bg-dark-hover transition-colors">
                        üèä Swimlanes
                    </button>
                    {% endif %}

                    <!-- Clear Filters -->
                    <button id="clear-filters" class="px-3 py-1.5 text-sm text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-dark-border rounded hover:bg-gray-100 dark:hover:bg-dark-hover transition-colors">
                        Clear Filters
                    </button>

                    <!-- Auto-refresh indicator -->
                    <div class="ml-auto text-sm text-gray-600 dark:text-gray-400">
                        Auto-refresh: <span id="refresh-countdown" class="text-primary">30</span>s
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kanban Board Container with Horizontal Scroll -->
    <div class="flex-1 overflow-x-auto overflow-y-hidden p-4">
        <div class="flex gap-4" style="min-width: fit-content;">
            <!-- Proposed Column -->
            <div class="flex-shrink-0 w-80">
                <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-3 border border-gray-200 dark:border-dark-border">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-semibold text-gray-900 dark:text-gray-100">üìù Proposed</h3>
                        <span class="text-sm text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded" data-count="proposed">0</span>
                    </div>
                    <div class="kanban-column space-y-2 min-h-[500px]" data-status="proposed">
                        {% for issue in issues %}
                            {% if issue.status == 'proposed' %}
                                {{ render_issue_card(issue) }}
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- In Progress Column -->
            <div class="flex-shrink-0 w-80">
                <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-3 border border-yellow-200 dark:border-yellow-800/50">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-semibold text-yellow-700 dark:text-yellow-200">‚ö° In Progress</h3>
                        <span class="text-sm text-yellow-700 dark:text-yellow-300 bg-yellow-100 dark:bg-yellow-900/50 px-2 py-1 rounded" data-count="in_progress">0</span>
                    </div>
                    <div class="kanban-column space-y-2 min-h-[500px]" data-status="in_progress">
                        {% for issue in issues %}
                            {% if issue.status == 'in_progress' %}
                                {{ render_issue_card(issue) }}
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Review Column -->
            <div class="flex-shrink-0 w-80">
                <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-3 border border-purple-200 dark:border-purple-800/50">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-semibold text-purple-700 dark:text-purple-200">üëÄ Review</h3>
                        <span class="text-sm text-purple-700 dark:text-purple-300 bg-purple-100 dark:bg-purple-900/50 px-2 py-1 rounded" data-count="review">0</span>
                    </div>
                    <div class="kanban-column space-y-2 min-h-[500px]" data-status="review">
                        {% for issue in issues %}
                            {% if issue.status == 'review' %}
                                {{ render_issue_card(issue) }}
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Done Column -->
            <div class="flex-shrink-0 w-80">
                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3 border border-green-200 dark:border-green-800/50">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-semibold text-green-700 dark:text-green-200">‚úÖ Done</h3>
                        <span class="text-sm text-green-700 dark:text-green-300 bg-green-100 dark:bg-green-900/50 px-2 py-1 rounded" data-count="done">0</span>
                    </div>
                    <div class="kanban-column space-y-2 min-h-[500px]" data-status="done">
                        {% for issue in issues %}
                            {% if issue.status == 'done' %}
                                {{ render_issue_card(issue) }}
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Blocked Column -->
            <div class="flex-shrink-0 w-80">
                <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-3 border border-red-200 dark:border-red-800/50">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-semibold text-red-700 dark:text-red-200">üö´ Blocked</h3>
                        <span class="text-sm text-red-700 dark:text-red-300 bg-red-100 dark:bg-red-900/50 px-2 py-1 rounded" data-count="blocked">0</span>
                    </div>
                    <div class="kanban-column space-y-2 min-h-[500px]" data-status="blocked">
                        {% for issue in issues %}
                            {% if issue.status == 'blocked' %}
                                {{ render_issue_card(issue) }}
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Complete (Archive) Column -->
            <div class="flex-shrink-0 w-80">
                <div class="bg-teal-50 dark:bg-teal-900/20 rounded-lg p-3 border border-teal-200 dark:border-teal-800/50">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-semibold text-teal-700 dark:text-teal-200">Archive</h3>
                        <span class="text-sm text-teal-700 dark:text-teal-300 bg-teal-100 dark:bg-teal-900/50 px-2 py-1 rounded" data-count="archived">0</span>
                    </div>
                    <!-- Accept drops but do not render archived issues -->
                    <div class="kanban-column space-y-2 min-h-[500px]" data-status="archived" style="background-image: url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2296%22 height=%2296%22 fill=%22none%22 stroke=%22%2399F6E4%22 stroke-opacity=%220.2%22 viewBox=%220 0 24 24%22%3E%3Cpath stroke-linecap=%22round%22 stroke-linejoin=%22round%22 stroke-width=%221%22 d=%22M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: center; background-size: 96px 96px;">
                        <!-- Empty placeholder to ensure droppable area -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Load Sortable.js -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
// Initialize Kanban board
document.addEventListener('DOMContentLoaded', function() {
    // Initialize archived count from server data
    window.__archivedCount = {{ archived_count }};
    // Load saved filters from localStorage
    loadFilters();

    // Show delete button on card hover
    document.addEventListener('mouseover', function(e) {
        const card = e.target.closest('.kanban-card');
        if (card) {
            const deleteBtn = card.querySelector('.delete-btn');
            if (deleteBtn) deleteBtn.style.opacity = '1';
        }
    });

    document.addEventListener('mouseout', function(e) {
        const card = e.target.closest('.kanban-card');
        if (card && !card.contains(e.relatedTarget)) {
            const deleteBtn = card.querySelector('.delete-btn');
            if (deleteBtn) deleteBtn.style.opacity = '0';
        }
    });

    // Initialize drag and drop for each column
    const columns = document.querySelectorAll('.kanban-column');
    columns.forEach(column => {
        new Sortable(column, {
            group: 'kanban',
            animation: 150,
            ghostClass: 'opacity-50',
            chosenClass: 'chosen-card',
            dragClass: 'dragging',
            onEnd: function(evt) {
                const issueKey = evt.item.dataset.issueKey;
                const newStatus = evt.to.dataset.status;
                const oldStatus = evt.from.dataset.status;

                if (newStatus !== oldStatus) {
                    // If moving to archive, animate fade out then hide
                    if (newStatus === 'archived') {
                        // Add fade animation
                        evt.item.style.transition = 'opacity 0.3s ease-out';
                        evt.item.style.opacity = '0';

                        // After animation, hide and update
                        setTimeout(() => {
                            evt.item.style.display = 'none';
                            evt.item.dataset.status = 'archived';
                            // Increment archived count
                            window.__archivedCount = (window.__archivedCount || 0) + 1;
                            updateColumnCounts();
                        }, 300);
                    }
                    updateIssueStatus(issueKey, newStatus);
                }

                // Reapply filters
                applyFilters();
                updateColumnCounts();
            }
        });
    });

    // Filter functionality
    const filters = {
        search: document.getElementById('quick-search'),
        priority: document.getElementById('priority-filter'),
        module: document.getElementById('module-filter'),
        owner: document.getElementById('owner-filter'),
        type: document.getElementById('type-filter'),
        showCompleted: document.getElementById('show-completed'),
        createdFrom: document.getElementById('created-from'),
        createdTo: document.getElementById('created-to')
    };

    // Add event listeners to filters
    Object.values(filters).forEach(filter => {
        if (filter) {
            filter.addEventListener('change', applyFilters);
            if (filter.type === 'text') {
                filter.addEventListener('input', applyFilters);
            }
        }
    });

    // Clear filters button
    document.getElementById('clear-filters').addEventListener('click', clearFilters);

    // Swimlane toggle button
    const swimlaneBtn = document.getElementById('toggle-swimlanes');
    if (swimlaneBtn) {
        swimlaneBtn.addEventListener('click', function() {
            const isActive = this.classList.contains('active');
            if (isActive) {
                // Switch back to standard view
                this.classList.remove('active', 'bg-blue-600', 'text-white');
                this.classList.add('text-gray-700', 'dark:text-gray-300');
                showStandardView();
            } else {
                // Switch to swimlane view
                this.classList.add('active', 'bg-blue-600', 'text-white');
                this.classList.remove('text-gray-700', 'dark:text-gray-300');
                showSwimlaneView();
            }
        });
    }

    // Auto-refresh functionality
    let refreshCountdown = 30;
    const countdownElement = document.getElementById('refresh-countdown');

    setInterval(() => {
        refreshCountdown--;
        if (countdownElement) {
            countdownElement.textContent = refreshCountdown;
        }

        if (refreshCountdown <= 0) {
            refreshBoard();
            refreshCountdown = 30;
        }
    }, 1000);

    // Apply initial filters and update counts
    applyFilters();
    updateColumnCounts();
});

// Apply filters to cards
function applyFilters() {
    const searchTerm = document.getElementById('quick-search').value.toLowerCase();
    const priority = document.getElementById('priority-filter').value;
    const module = document.getElementById('module-filter').value;
    const owner = document.getElementById('owner-filter').value;
    const type = document.getElementById('type-filter').value;
    const showCompleted = document.getElementById('show-completed').checked;
    const createdFrom = document.getElementById('created-from').value;
    const createdTo = document.getElementById('created-to').value;

    const cards = document.querySelectorAll('.kanban-card');

    cards.forEach(card => {
        let visible = true;

        // Search filter
        if (searchTerm && !card.dataset.title.includes(searchTerm) &&
            !card.dataset.issueKey.toLowerCase().includes(searchTerm)) {
            visible = false;
        }

        // Priority filter
        if (priority && card.dataset.priority !== priority) {
            visible = false;
        }

        // Module filter
        if (module && card.dataset.module !== module) {
            visible = false;
        }

        // Owner filter
        if (owner && card.dataset.owner !== owner) {
            visible = false;
        }

        // Type filter
        if (type && card.dataset.type !== type) {
            visible = false;
        }

        // Date range filter
        if (createdFrom || createdTo) {
            const cardDate = new Date(card.dataset.created).toISOString().split('T')[0];
            if (createdFrom && cardDate < createdFrom) {
                visible = false;
            }
            if (createdTo && cardDate > createdTo) {
                visible = false;
            }
        }

        // Completed filter: hide archived always; hide done when toggled off
        if (card.dataset.status === 'archived') {
            visible = false;
        } else if (!showCompleted && card.dataset.status === 'done') {
            visible = false;
        }

        card.style.display = visible ? 'block' : 'none';
    });

    // Save filters to localStorage
    saveFilters();

    // Update column counts
    updateColumnCounts();
}

// Clear all filters
function clearFilters() {
    document.getElementById('quick-search').value = '';
    document.getElementById('priority-filter').value = '';
    document.getElementById('module-filter').value = '';
    document.getElementById('owner-filter').value = '';
    document.getElementById('type-filter').value = '';
    document.getElementById('show-completed').checked = true;
    document.getElementById('created-from').value = '';
    document.getElementById('created-to').value = '';

    applyFilters();
}

// Save filters to localStorage
function saveFilters() {
    const filterState = {
        search: document.getElementById('quick-search').value,
        priority: document.getElementById('priority-filter').value,
        module: document.getElementById('module-filter').value,
        owner: document.getElementById('owner-filter').value,
        type: document.getElementById('type-filter').value,
        showCompleted: document.getElementById('show-completed').checked,
        createdFrom: document.getElementById('created-from').value,
        createdTo: document.getElementById('created-to').value
    };

    localStorage.setItem('kanban-filters-{{ project.project_id }}', JSON.stringify(filterState));
}

// Load filters from localStorage
function loadFilters() {
    const savedFilters = localStorage.getItem('kanban-filters-{{ project.project_id }}');

    if (savedFilters) {
        try {
            const filterState = JSON.parse(savedFilters);

            if (filterState.search !== undefined) {
                document.getElementById('quick-search').value = filterState.search;
            }
            if (filterState.priority !== undefined) {
                document.getElementById('priority-filter').value = filterState.priority;
            }
            if (filterState.module !== undefined) {
                document.getElementById('module-filter').value = filterState.module;
            }
            if (filterState.owner !== undefined) {
                document.getElementById('owner-filter').value = filterState.owner;
            }
            if (filterState.type !== undefined) {
                document.getElementById('type-filter').value = filterState.type;
            }
            if (filterState.showCompleted !== undefined) {
                document.getElementById('show-completed').checked = filterState.showCompleted;
            }
            if (filterState.createdFrom !== undefined) {
                document.getElementById('created-from').value = filterState.createdFrom;
            }
            if (filterState.createdTo !== undefined) {
                document.getElementById('created-to').value = filterState.createdTo;
            }
        } catch (e) {
            console.error('Error loading filters:', e);
        }
    }
}

// Update column counts
function updateColumnCounts() {
    const statuses = ['proposed', 'in_progress', 'review', 'done', 'blocked', 'archived'];

    statuses.forEach(status => {
        const column = document.querySelector(`.kanban-column[data-status="${status}"]`);
        const countElement = document.querySelector(`[data-count="${status}"]`);

        if (column && countElement) {
            if (status === 'archived') {
                // Use server-derived count for archived since we don't render archived cards
                countElement.textContent = (typeof window.__archivedCount === 'number') ? window.__archivedCount : 0;
            } else {
                const visibleCards = column.querySelectorAll('.kanban-card:not([style*="display: none"])');
                countElement.textContent = visibleCards.length;
            }
        }
    });
}

// Update issue status via API
async function updateIssueStatus(issueKey, newStatus) {
    try {
        const response = await fetch('/api/issues/upsert', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                key: issueKey,
                status: newStatus
            })
        });

        if (!response.ok) {
            throw new Error('Failed to update issue status');
        }

        console.log(`Updated ${issueKey} to ${newStatus}`);
        // If archived, update counts
        if (newStatus === 'archived') {
            updateColumnCounts();
        }
    } catch (error) {
        console.error('Error updating issue status:', error);
        // Optionally refresh to restore original state
        refreshBoard();
    }
}

// Delete issue function
async function deleteIssue(issueKey, event) {
    event.preventDefault();
    event.stopPropagation();

    if (!confirm(`Are you sure you want to delete issue ${issueKey}?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/issues/${issueKey}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!response.ok) {
            throw new Error('Failed to delete issue');
        }

        // Remove the card from UI
        const card = document.querySelector(`[data-issue-key="${issueKey}"]`);
        if (card) {
            card.remove();
            updateColumnCounts();
        }

        console.log(`Deleted issue ${issueKey}`);
    } catch (error) {
        console.error('Error deleting issue:', error);
        alert('Failed to delete issue');
    }
}

// Refresh the board
async function refreshBoard() {
    try {
        // Get current filter state
        const filterState = {
            search: document.getElementById('quick-search').value,
            priority: document.getElementById('priority-filter').value,
            module: document.getElementById('module-filter').value,
            owner: document.getElementById('owner-filter').value,
            type: document.getElementById('type-filter').value,
            showCompleted: document.getElementById('show-completed').checked,
            createdFrom: document.getElementById('created-from').value,
            createdTo: document.getElementById('created-to').value
        };

        // Reload the page (simplest approach for now)
        window.location.reload();

        // After reload, filters will be restored from localStorage
    } catch (error) {
        console.error('Error refreshing board:', error);
    }
}

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + F to focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById('quick-search').focus();
    }

    // Escape to clear search
    if (e.key === 'Escape') {
        const searchField = document.getElementById('quick-search');
        if (document.activeElement === searchField) {
            searchField.value = '';
            applyFilters();
            searchField.blur();
        }
    }

    // R to refresh
    if (e.key === 'r' && !e.ctrlKey && !e.metaKey &&
        document.activeElement.tagName !== 'INPUT' &&
        document.activeElement.tagName !== 'SELECT') {
        e.preventDefault();
        refreshBoard();
    }
});

// Swimlane view functions
function showSwimlaneView() {
    // Hide standard kanban board
    const standardBoard = document.querySelector('.flex.gap-4');
    standardBoard.style.display = 'none';

    // Create or show swimlane view
    let swimlaneContainer = document.getElementById('swimlane-view');
    if (!swimlaneContainer) {
        swimlaneContainer = createSwimlaneView();
        standardBoard.parentNode.insertBefore(swimlaneContainer, standardBoard.nextSibling);
    } else {
        swimlaneContainer.style.display = 'block';
    }
}

function showStandardView() {
    // Show standard kanban board
    const standardBoard = document.querySelector('.flex.gap-4');
    standardBoard.style.display = '';

    // Hide swimlane view
    const swimlaneContainer = document.getElementById('swimlane-view');
    if (swimlaneContainer) {
        swimlaneContainer.style.display = 'none';
    }
}

function createSwimlaneView() {
    const container = document.createElement('div');
    container.id = 'swimlane-view';
    container.className = 'overflow-x-auto';

    // Get all submodules and issues
    const submodules = {{ project.submodules|tojson if project.submodules else '[]' }};
    const issues = Array.from(document.querySelectorAll('.kanban-card'));

    let html = '<div class="min-w-fit">';

    // Create swimlane for each submodule
    submodules.forEach(submodule => {
        html += `
            <div class="mb-6 border-b border-gray-200 dark:border-dark-border pb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3 px-2 flex items-center">
                    <span class="bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 px-2 py-1 rounded text-sm mr-3">
                        ${submodule.name}
                    </span>
                    <span class="text-sm text-gray-500">${submodule.path}</span>
                </h3>
                <div class="flex gap-4 px-2">
                    <div class="flex-shrink-0 w-72">
                        <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-3 border border-gray-200 dark:border-dark-border">
                            <h4 class="font-medium text-sm text-gray-700 dark:text-gray-300 mb-2">üìù Proposed</h4>
                            <div class="swimlane-column space-y-2 min-h-[80px]" data-status="proposed" data-module="${submodule.name}"></div>
                        </div>
                    </div>
                    <div class="flex-shrink-0 w-72">
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-3 border border-yellow-200 dark:border-yellow-800">
                            <h4 class="font-medium text-sm text-gray-700 dark:text-gray-300 mb-2">‚ö° In Progress</h4>
                            <div class="swimlane-column space-y-2 min-h-[80px]" data-status="in_progress" data-module="${submodule.name}"></div>
                        </div>
                    </div>
                    <div class="flex-shrink-0 w-72">
                        <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-3 border border-purple-200 dark:border-purple-800">
                            <h4 class="font-medium text-sm text-gray-700 dark:text-gray-300 mb-2">üîç Review</h4>
                            <div class="swimlane-column space-y-2 min-h-[80px]" data-status="review" data-module="${submodule.name}"></div>
                        </div>
                    </div>
                    <div class="flex-shrink-0 w-72">
                        <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3 border border-green-200 dark:border-green-800">
                            <h4 class="font-medium text-sm text-gray-700 dark:text-gray-300 mb-2">‚úÖ Done</h4>
                            <div class="swimlane-column space-y-2 min-h-[80px]" data-status="done" data-module="${submodule.name}"></div>
                        </div>
                    </div>
                    <div class="flex-shrink-0 w-72">
                        <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-3 border border-red-200 dark:border-red-800">
                            <h4 class="font-medium text-sm text-gray-700 dark:text-gray-300 mb-2">üöß Blocked</h4>
                            <div class="swimlane-column space-y-2 min-h-[80px]" data-status="blocked" data-module="${submodule.name}"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;

    // Distribute cards to swimlanes
    issues.forEach(card => {
        const module = card.dataset.module;
        const status = card.dataset.status;
        if (module && status !== 'archived') {
            const swimlaneColumn = container.querySelector(`.swimlane-column[data-status="${status}"][data-module="${module}"]`);
            if (swimlaneColumn) {
                const clonedCard = card.cloneNode(true);
                swimlaneColumn.appendChild(clonedCard);
            }
        }
    });

    // Initialize drag and drop for swimlanes
    container.querySelectorAll('.swimlane-column').forEach(column => {
        new Sortable(column, {
            group: 'swimlane',
            animation: 150,
            ghostClass: 'opacity-50',
            onEnd: function(evt) {
                const issueKey = evt.item.dataset.issueKey;
                const newStatus = evt.to.dataset.status;
                const newModule = evt.to.dataset.module;
                updateIssueStatus(issueKey, newStatus);
                // Also update the card in the standard view
                syncCardToStandardView(issueKey, newStatus);
            }
        });
    });

    return container;
}

function syncCardToStandardView(issueKey, newStatus) {
    // Find the card in standard view and move it to the correct column
    const standardCard = document.querySelector(`.kanban-column .kanban-card[data-issue-key="${issueKey}"]`);
    if (standardCard) {
        const targetColumn = document.querySelector(`.kanban-column[data-status="${newStatus}"]`);
        if (targetColumn && !targetColumn.contains(standardCard)) {
            targetColumn.appendChild(standardCard);
            standardCard.dataset.status = newStatus;
        }
    }
}

// Custom styles for dragging
const style = document.createElement('style');
style.textContent = `
    .dragging {
        opacity: 0.4;
    }
    .chosen-card {
        outline: 2px solid #3B82F6;
        outline-offset: 2px;
    }
    .kanban-card {
        transition: all 0.2s ease;
    }
    .kanban-card:hover {
        transform: translateY(-2px);
    }
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .kanban-column {
        scrollbar-width: thin;
        scrollbar-color: #4B5563 transparent;
    }
    .kanban-column::-webkit-scrollbar {
        width: 6px;
    }
    .kanban-column::-webkit-scrollbar-track {
        background: transparent;
    }
    .kanban-column::-webkit-scrollbar-thumb {
        background-color: #4B5563;
        border-radius: 3px;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}